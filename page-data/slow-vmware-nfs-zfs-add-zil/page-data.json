{"componentChunkName":"component---src-templates-post-js","path":"/slow-vmware-nfs-zfs-add-zil","result":{"data":{"markdownRemark":{"html":"<p>A short post on how I exponentially sped up my VMware environment.</p>\n<!-- more -->\n<p>Even with 20-30 or so VMs, I always found that they were always unresponsive or slow to do very standard things like logging in, listing directories, reading files.</p>\n<h4 id=\"slow-performance-factors\" style=\"position:relative;\"><a href=\"#slow-performance-factors\" aria-label=\"slow performance factors permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Slow Performance Factors</h4>\n<p>I knew it was down to four main factors: CPU, memory, network or storage.</p>\n<ul>\n<li>It definitely wasn't the CPU as vSphere showed only 25% usage.</li>\n<li>It might be the memory since I'm a bit cheap and allocate 256MB or 512MB</li>\n<li>I don't think it's the network since I'm teaming four connections together for 4 gigabits/s</li>\n<li>I wouldn't assume it to be the storage since I'm mirroring two Samsung 840 Pro SSDs together</li>\n</ul>\n<h4 id=\"the-reason\" style=\"position:relative;\"><a href=\"#the-reason\" aria-label=\"the reason permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Reason</h4>\n<p>Cutting to the point, after playing around with it all I realised that the storage was the limiting factor.</p>\n<p>A few searches on the net led me to find that the reason for slow performance was the fact that <strong>VMware ALWAYS writes to the NFS datastore using FSYNC</strong> meaning that it's gotta wait for an acknowledge before any data is written.</p>\n<h4 id=\"the-solution-zil\" style=\"position:relative;\"><a href=\"#the-solution-zil\" aria-label=\"the solution zil permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Solution: ZIL</h4>\n<p>The solution to increasing the speed of FSYNC is to add a ZFS Intent Log or ZIL drive. This requires a fast disk such as an SSD or battery-backed NVRAM. The simple explanation of how a ZIL works is that it takes any writes to the zpool and hold them until it is free to flush them over.</p>\n<p>The downside of using this is that if the log device is lost, it is possible to lose the latest writes which could result in the loss of the entire zpool. This is hence why it is recommended to use a battery-backed device which can store these writes until the next time the zpool is powered on to flush over the data.</p>\n<p>I ended up using an old Intel 60GB SSD (thick provisioned through VMware) onto my Samsung 840 Pro mirror.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 467px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1e720de99388acdcbf8fcb025c5d66f0/128f7/capture.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.47887323943662%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsTAAALEwEAmpwYAAABIklEQVQoz5WR2W4DIQxF8/8f2DZRUynNLAlkGGwWAzZQJSN1UfvS82b5HtuSdxTjMIzTNKmr6v9kl4imcbper+Mw2tVaa2MIDt1iDCB6HxAhhICADpFSQocWrAUAwJ33fp5nZm6tpZRyyszCXFLOzCxSc8kiUsq9qrUyl1xyebBrrfXezWIAsPe+lRuIdlkWYdFa65s2xiitmfnr7C29mvXeEK61fo6YhvPL86HWFoIPIQbvnXOllC/5M7qaZb8/HF+Pp/fT8fg2DMM4nJ+e9q31knPOhYgSpR/yZhJFu65a3y7zRSk1zxetNAJofWu9i7CI8AMR+b75Luec5ulClL5/AgGUuvXeH+5fMlEMIcQYHd4BAB8cEfXea61btD34/ecPs9MJLmTACkMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Capture\"\n        title=\"Capture\"\n        src=\"/static/1e720de99388acdcbf8fcb025c5d66f0/128f7/capture.png\"\n        srcset=\"/static/1e720de99388acdcbf8fcb025c5d66f0/53f68/capture.png 213w,\n/static/1e720de99388acdcbf8fcb025c5d66f0/df70d/capture.png 425w,\n/static/1e720de99388acdcbf8fcb025c5d66f0/128f7/capture.png 467w\"\n        sizes=\"(max-width: 467px) 100vw, 467px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h4 id=\"performance\" style=\"position:relative;\"><a href=\"#performance\" aria-label=\"performance permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Performance</h4>\n<p>A simple test I do is just performing an apt-update and dist-upgrade on VMs I haven't touched in a while</p>\n<ul>\n<li>Without ZIL: 25 minutes</li>\n<li>With ZIL: 1 minute!!!!</li>\n</ul>\n<p>It was an amazing speed boost. I was amazed how fast everything is right now and why I didn't do this sooner.</p>","timeToRead":2,"excerpt":"A short post on how I exponentially sped up my VMware environment. Even with 20-30 or so VMs, I always found that they were always…","fileAbsolutePath":"/home/runner/work/calvin.me/calvin.me/master/posts/2015/2015-07-07-slow-vmware-nfs-zfs-add-zil/index.md","frontmatter":{"title":"Slow VMware NFS on ZFS? Add a ZIL!","categories":["Storage","Virtualisation"],"tags":["nfs","vmware","zfs","zil"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#080808","images":{"fallback":{"src":"/static/e8cd86f277a2f44073533548126c07a1/ccc8a/thumbnail.png","srcSet":"/static/e8cd86f277a2f44073533548126c07a1/ccc8a/thumbnail.png 150w,\n/static/e8cd86f277a2f44073533548126c07a1/67d4a/thumbnail.png 300w","sizes":"150px"},"sources":[{"srcSet":"/static/e8cd86f277a2f44073533548126c07a1/3554d/thumbnail.webp 150w,\n/static/e8cd86f277a2f44073533548126c07a1/c437f/thumbnail.webp 300w","type":"image/webp","sizes":"150px"}]},"width":150,"height":150}}}}}},"pageContext":{"filter":"/^.*\\/\\d{4}-\\d{2}-\\d{2}-slow-vmware-nfs-zfs-add-zil\\/.*$/"}},"staticQueryHashes":[]}