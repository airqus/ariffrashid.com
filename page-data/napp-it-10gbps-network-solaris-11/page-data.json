{
    "componentChunkName": "component---src-templates-post-js",
    "path": "/napp-it-10gbps-network-solaris-11",
    "result": {"data":{"markdownRemark":{"html":"<p>While it can be difficult to have a transfer speed of 1.25GB per second (10Gbp/s), it wouldn't hurt to make sure it works well right?</p>\n<!-- more -->\n<p>After some not-so-great performance from my VMXNET3 adapters on napp-it, I decided to investigate how to improve network performance. Theoretically, I believe it is impossible for me to achieve a network transfer of 1.25GB per second.</p>\n<h2 id=\"iperf\" style=\"position:relative;\"><a href=\"#iperf\" aria-label=\"iperf permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>iPerf</h2>\n<p>All networking testing is done using <a href=\"https://iperf.fr\">iPerf</a> (specifically iPerf 2 as napp-it comes with it bundled). iPerf mesaures network performance through TCP, UDP and SCTP.</p>\n<p>For my tests I used the following systems all running iperf</p>\n<ul>\n<li>Ubuntu 14.10 Desktop</li>\n<li>Ubuntu 14.04.3 Server</li>\n<li>Windows Server 2012 R2</li>\n<li>Solaris 11 (running napp-it) - most importantly</li>\n</ul>\n<h2 id=\"enabling-jumbo-frames\" style=\"position:relative;\"><a href=\"#enabling-jumbo-frames\" aria-label=\"enabling jumbo frames permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Enabling Jumbo Frames</h2>\n<p>First thing to do is enable jumbo frames. Typically, networks set their 'maximum transmission unit' or MTU to 1500 bytes. A jumbo frame on the otherhand can carry up to 9000 bytes of payload.</p>\n<p>To enable jumbo frames on Solaris 11, Oracle provides a <a href=\"https://docs.oracle.com/cd/E19120-01/open.solaris/819-6990/ggtwf/index.html\">very easy guide</a> to this:</p>\n<p><strong>1.</strong> Select the interface to enable jumbo frames on, list it using the command:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell-session\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell-session line-numbers\"><code class=\"language-shell-session\"><span class=\"token command\"><span class=\"token shell-symbol important\">$</span> <span class=\"token bash language-bash\">dladm show-phys</span></span>\n<span class=\"token output\">LINK      MEDIA    STATE SPEED DUPLEX DEVICE\nvmxnet3s0 Ethernet up    10000 full   vmxnet3s0</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<p><strong>2.</strong> See the current MTU, replacing vmxnet3s0 with your interface</p>\n<div class=\"gatsby-highlight\" data-language=\"shell-session\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell-session line-numbers\"><code class=\"language-shell-session\"><span class=\"token command\"><span class=\"token shell-symbol important\">$</span> <span class=\"token bash language-bash\">dladm show-linkprop -p mtu vmxnet3s0</span></span>\n<span class=\"token output\">LINK      PROPERTY PERM VALUE DEFAULT POSSIBLE\nvmxnet3s0 mtu      rw   1500  1500    60-9000</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<p><strong>3.</strong> Turn off the interface to configure it</p>\n<div class=\"gatsby-highlight\" data-language=\"shell-session\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell-session line-numbers\"><code class=\"language-shell-session\"><span class=\"token output\">ifconfig vmxnet3s0 unplumb</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p><strong>4.</strong> Set MTU to 9000</p>\n<div class=\"gatsby-highlight\" data-language=\"shell-session\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell-session line-numbers\"><code class=\"language-shell-session\"><span class=\"token output\">dladm set-linkprop -p mtu=9000 vmxnet3s0</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p><strong>5.</strong> Re-enable the interface</p>\n<div class=\"gatsby-highlight\" data-language=\"shell-session\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell-session line-numbers\"><code class=\"language-shell-session\"><span class=\"token output\">ifconfig vmxnet3s0 plumb 10.0.0.5/24 up</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p><strong>6.</strong> Check if it has updated</p>\n<div class=\"gatsby-highlight\" data-language=\"shell-session\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell-session line-numbers\"><code class=\"language-shell-session\"><span class=\"token command\"><span class=\"token shell-symbol important\">$</span> <span class=\"token bash language-bash\">dladm show-link vmxnet3s0</span></span>\n<span class=\"token output\">LINK      CLASS MTU  STATE BRIDGE OVER\nvmxnet3s0 phys  9000 up    --     --</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<p>At this point you can test the Jumbo Frames using a ping to a machine which can accept an MTU of 9000. I did a ping to my Ubuntu Desktop.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell-session\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell-session line-numbers\"><code class=\"language-shell-session\"><span class=\"token command\"><span class=\"token shell-symbol important\">$</span> <span class=\"token bash language-bash\"><span class=\"token function\">ping</span> -s <span class=\"token number\">10.0</span>.0.16 <span class=\"token number\">9000</span> <span class=\"token number\">4</span></span></span>\n\n<span class=\"token output\">PING 10.0.0.16: 9000 data bytes\n9008 bytes from 10.0.0.16: icmp_seq=0. time=0.223 ms\n9008 bytes from 10.0.0.16: icmp_seq=1. time=0.228 ms\n9008 bytes from 10.0.0.16: icmp_seq=2. time=0.243 ms\n9008 bytes from 10.0.0.16: icmp_seq=3. time=0.222 ms\n\n----10.0.0.16 PING Statistics----\n4 packets transmitted, 4 packets received, 0% packet loss\nround-trip (ms)  min/avg/max/stddev = 0.222/0.229/0.243/0.010</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id=\"enable-jumbo-frames-everywhere\" style=\"position:relative;\"><a href=\"#enable-jumbo-frames-everywhere\" aria-label=\"enable jumbo frames everywhere permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Enable Jumbo Frames everywhere</h2>\n<p>At this point you'll want to enable Jumbo Frames everywhere, most importantly ESXi vSwitches and even physical switches. Simply do this by changing the MTU to 9000.</p>\n<p>Of course this depends on the hardware you are using so I can't help much here.</p>\n<h2 id=\"disable-lso\" style=\"position:relative;\"><a href=\"#disable-lso\" aria-label=\"disable lso permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disable LSO</h2>\n<p>LSO or Large Segment Offload is a technology to reduce CPU while having better network performance through segmentation. Segmentation however is not required if we are using an MTU of 9000 however.</p>\n<p><strong>1.</strong> Run the following command to disable LSO though Solaris</p>\n<div class=\"gatsby-highlight\" data-language=\"shell-session\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell-session line-numbers\"><code class=\"language-shell-session\"><span class=\"token output\">ndd -set /dev/ip ip_lso_outbound 0</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p><strong>2.</strong> Disable LSO through the VMXNET3 driver. Edit /kernel/drv/vmxnet3s.conf. I changed EnableLSO and MTU near the bottom of the file.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">EnableLSO=0,0,0,0,0,0,0,0,0,0;\nMTU=9000,9000,9000,9000,9000,9000,9000,9000,9000,9000;</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<h2 id=\"tuning\" style=\"position:relative;\"><a href=\"#tuning\" aria-label=\"tuning permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tuning</h2>\n<p>Finally tune TCP parameters to accommodate the faster speeds</p>\n<div class=\"gatsby-highlight\" data-language=\"shell-session\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell-session line-numbers\"><code class=\"language-shell-session\"><span class=\"token output\">ipadm set-prop -p max_buf=4194304 tcp\nipadm set-prop -p recv_buf=1048576 tcp\nipadm set-prop -p send_buf=1048576 tcp</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<h2 id=\"test-out-your-new-performance\" style=\"position:relative;\"><a href=\"#test-out-your-new-performance\" aria-label=\"test out your new performance permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Test out your new performance</h2>\n<p>Start iperf 2 as a server on napp-it</p>\n<div class=\"gatsby-highlight\" data-language=\"shell-session\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell-session line-numbers\"><code class=\"language-shell-session\"><span class=\"token output\">cd /var/web-gui/data/tools/iperf\n./iperf -s</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>On another computer, run iperf as a client to connect to napp-it.</p>\n<p>Here are the results from my Windows Server 2012 VM. It is quite common to see decreased speeds when running iPerf on Windows. <strong>Only 1.82 gigabits per second.</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"shell-session\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell-session line-numbers\"><code class=\"language-shell-session\"><span class=\"token output\">C:iperf.exe -c 10.0.0.5\n\n------------------------------------------------------------\nClient connecting to 10.0.0.5, TCP port 5001\nTCP window size: 63.0 KByte (default)\n------------------------------------------------------------\n[ 3] local 10.0.0.16 port 50879 connected with 10.0.0.5 port 5001\n[ ID] Interval Transfer Bandwidth\n[ 3] 0.0-10.0 sec 2.12 GBytes 1.82 Gbits/sec</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Results from Ubuntu Desktop! Amazing! <strong>15.4 gigabits per second!!!</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"shell-session\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell-session line-numbers\"><code class=\"language-shell-session\"><span class=\"token command\"><span class=\"token shell-symbol important\">$</span> <span class=\"token bash language-bash\">iperf -c <span class=\"token number\">10.0</span>.0.5</span></span>\n<span class=\"token output\">------------------------------------------------------------\nClient connecting to 10.0.0.5, TCP port 5001\nTCP window size:  325 KByte (default)\n------------------------------------------------------------\n[  3] local 10.0.1.29 port 59889 connected with 10.0.0.5 port 5001\n[ ID] Interval       Transfer     Bandwidth\n[  3]  0.0-10.0 sec  17.9 GBytes  15.4 Gbits/sec</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>From my Windows 10 Desktop. It's going over a gigabit switch that does not support Jumbo Frames. <strong>528 megabits per second.</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"shell-session\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell-session line-numbers\"><code class=\"language-shell-session\"><span class=\"token output\">C:>iperf-2.0.5-3-win32>iperf.exe -c 10.0.0.5\n------------------------------------------------------------\nClient connecting to 10.0.0.5, TCP port 5001\nTCP window size: 63.0 KByte (default)\n------------------------------------------------------------\n[  3] local 10.0.1.41 port 54698 connected with 10.0.0.5 port 5001\n[ ID] Interval       Transfer     Bandwidth\n[  3]  0.0-10.0 sec   630 MBytes   528 Mbits/sec</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>","timeToRead":4,"excerpt":"While it can be difficult to have a transfer speed of 1.25GB per second (10Gbp/s), it wouldn't hurt to make sure it works well right? After…","fileAbsolutePath":"/home/runner/work/ariffrashid.com/ariffrashid.com/master/posts/2016/2016-01-11-napp-it-10gbps-network-solaris-11/index.md","frontmatter":{"title":"Improve 10Gbps Performance on napp-it (Solaris 11)","categories":["Networking","Virtualisation"],"tags":["10 gigabit network","10gbe","10gbps","10ge","jumbo frames","lso","mtu","napp-it","solaris","solaris 11"],"thumbnail":{"childImageSharp":null,"extension":"svg","publicURL":"/static/c7452475796dd8b606f0a361e657f0fa/thumbnail.svg"}}}},"pageContext":{"filter":"/^.*\\/\\d{4}-\\d{2}-\\d{2}-napp-it-10gbps-network-solaris-11\\/.*$/"}},
    "staticQueryHashes": []}