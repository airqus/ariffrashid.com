{"componentChunkName":"component---src-templates-post-js","path":"/forward-ip-addresses-when-using-nginx-proxy","result":{"data":{"markdownRemark":{"html":"<p>I love nginx. I love how its lightweight, does what it does well and is <a href=\"http://www.theorganicagency.com/apache-vs-nginx-performance-comparison/\">extremely <strong>fast</strong></a>. Nginx has the ability to perform server blocks (virtual hosts in Apache) which is great, though causes problems when having to forward IP addresses within its proxy headers. There is a solution.</p>\n<!-- more -->\n<p><em>Off-topic: This year ASIC blocked 250000 websites because its blacklisted websites based on their IP addresses instead of their domain name as they were running Virtual Hosts/Server Blocks! Quite a blunder when you get people that don't know how the Internet works to regulate it. <a href=\"http://www.abc.net.au/news/2014-08-27/asic-accidentally-blocked-250000-websites-ip-address/5701734\">Read it here</a>. Take a stand against things like this - see what you can do at <a href=\"https://stopthespies.org/\">https://stopthespies.org</a> as Australia plans to track and record your online movements (even physical moments on your mobile devices!).</em></p>\n<h2 id=\"edit-the-proxy-configuration\" style=\"position:relative;\"><a href=\"#edit-the-proxy-configuration\" aria-label=\"edit the proxy configuration permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Edit the proxy configuration</h2>\n<p>First thing is to edit your proxy server block located on the proxy server. Here's what mine basically looks like:</p>\n<div class=\"gatsby-highlight\" data-language=\"nginx\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-nginx line-numbers\"><code class=\"language-nginx\"><span class=\"token comment\">## redirect calvin.me to https</span>\n<span class=\"token directive\"><span class=\"token keyword\">server</span></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token directive\"><span class=\"token keyword\">listen</span>      <span class=\"token number\">80</span> default_server</span><span class=\"token punctuation\">;</span>\n  <span class=\"token directive\"><span class=\"token keyword\">server_name</span> calvin.me</span><span class=\"token punctuation\">;</span>\n  <span class=\"token directive\"><span class=\"token keyword\">return</span> <span class=\"token number\">301</span> https://calvin.me</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">## redirect www prefix to https</span>\n<span class=\"token directive\"><span class=\"token keyword\">server</span></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token directive\"><span class=\"token keyword\">listen</span>      <span class=\"token number\">80</span></span><span class=\"token punctuation\">;</span>\n  <span class=\"token directive\"><span class=\"token keyword\">server_name</span> www.calvin.me</span><span class=\"token punctuation\">;</span>\n  <span class=\"token directive\"><span class=\"token keyword\">return</span> <span class=\"token number\">301</span> https://www.calvin.me</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token directive\"><span class=\"token keyword\">server</span></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">#listen 80;</span>\n  <span class=\"token directive\"><span class=\"token keyword\">listen</span> <span class=\"token number\">443</span> ssl default_server</span><span class=\"token punctuation\">;</span>\n  <span class=\"token directive\"><span class=\"token keyword\">server_name</span> calvin.me</span><span class=\"token punctuation\">;</span>\n  <span class=\"token directive\"><span class=\"token keyword\">ssl_certificate</span> /etc/nginx/ssl/calvin.me.crt</span><span class=\"token punctuation\">;</span>\n  <span class=\"token directive\"><span class=\"token keyword\">ssl_certificate_key</span> /etc/nginx/ssl/calvin.me.key</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token directive\"><span class=\"token keyword\">location</span> /</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span>  Host <span class=\"token variable\">$host</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span>  X-Real-IP <span class=\"token variable\">$remote_addr</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span>  X-Forwarded-Proto https</span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span>  X-Forwarded-For <span class=\"token variable\">$remote_addr</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span>  X-Forwarded-Host <span class=\"token variable\">$remote_addr</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">proxy_pass</span>        http://wp.calvin.me</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>It's very important to include these three lines:</p>\n<ul>\n<li>Host: name and port of the proxied server.</li>\n<li>X-Real-IP: sends the visitor's IP address to your virtual host</li>\n<li>X-Forwarded-For: sends the visitor's IP address to your virtual host</li>\n</ul>\n<h2 id=\"edit-your-proxied-server-configuration\" style=\"position:relative;\"><a href=\"#edit-your-proxied-server-configuration\" aria-label=\"edit your proxied server configuration permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Edit your proxied server configuration</h2>\n<p>Now on your proxied server's configuration you'll need to include three importants lines within the server block, but outside of any location blocks.</p>\n<div class=\"gatsby-highlight\" data-language=\"nginx\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-nginx line-numbers\"><code class=\"language-nginx\"><span class=\"token directive\"><span class=\"token keyword\">server</span></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">#other junk here blah blah</span>\n    <span class=\"token directive\"><span class=\"token keyword\">set_real_ip_from</span> 10.0.0.0/8</span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">real_ip_header</span> X-Real-IP</span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">real_ip_recursive</span> <span class=\"token boolean\">on</span></span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token directive\"><span class=\"token keyword\">location</span> /</span> <span class=\"token punctuation\">{</span>\n       <span class=\"token comment\">#some junk here</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>The three lines are:</p>\n<ul>\n<li>set_real_ip_from: this tells nginx to grab the real visitor's IP from any proxy server within this range. This can also be a static IP address such as 10.0.9.2</li>\n<li>real_ip_header: nginx will pick out the client's IP address from the addresses its given</li>\n<li>real_ip_recursive: the proxy server's IP is replaced by the visitor's IP address</li>\n</ul>\n<h2 id=\"example---im-gonna-the-forward-ip-addresses\" style=\"position:relative;\"><a href=\"#example---im-gonna-the-forward-ip-addresses\" aria-label=\"example   im gonna the forward ip addresses permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Example - I'm gonna the forward IP addresses</h2>\n<p>The reason I posted this was because on this site, comments left by you guys were shown as coming from my proxy server (10.0.9.2), hiding everyone's IP address behind my own proxy server. Take a look</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 212px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ed619c2e4b3009f87075d49c0b1f80c6/9a366/comments-b4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 135.37735849056602%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAbCAIAAADzvTiPAAAACXBIWXMAAAsTAAALEwEAmpwYAAADOElEQVQ4y5WTzWvbZhzHFXKq1ZaOkfwXCUk3J7YLbehyCIPmFgKDnAY77TR26S7bIYMVdtqgO4xddik7rafSdIdSaC9Lm6axk9iyLcl6jd4fSX70vEnWsL21TWKb7MMXPULo+7z8nu+P03WjWq0eHh51Oorve+22KEtSp6NIotyRZUmWXc+jlJJRcJIkq6rqOG6j3vQ8VxT75mazKYqi2pEFQbBsZ6xZ03QAAEySjqx0ERYMV7YC0XQVBxCW5nmPMUbGwEEIMcYE4yRJIISG65mu7wah6YcJQnjAWDNjLM/zXi8jpP8fo4TR/jMdLIgnwgEAnj9/sf/mIE17jFFMCKU0yzKEMaEsy7J8PFy1drS6vPjZ2oqqGGEIhOPDWvWgITSltrC7tx9H0WBfvdHm2lH98zu3v1y/fVCtYco02/cjGCcIdKETxkEMY0wgIlGCGWNnZuEUTfv1px//+O0XTTejBIuWX1MtxQ3NIJIcIOi26AIHRHXdC6I4S9NT5nK5fPPWys1bK5VKuVQqlcul5eXl4UupVKpU+p9v3Kh8dP365uYmQuj9U3B8oXB5oCuX+atX+EKhULhUKFwa8N/I8/zU1NTCwgKE8JRZ1oy94+abRntfEF8L0ontBoF/Hs/zAABnz8yyrItphEiEKUB00s2crzalpJexLGVZSjNGGaODaKCRIgS/L86yrEZDEBpNXe/fs3VigjDEGCGUjFOSwKG4Vqvdaom6ZtaPBU1Xjw+rJ5bTj9q5dd7q7SycJMq2ZaMEvXq5t7i4cO3aB7Ozsx+OYmZmhuf5crkcRRFjrJ/tMASU0jzPDcNYX78zPz9fLBY/HsXS0tLc3NzGxkYcx/+anQAIyolk2G3Tli0fEZpl6WTetSSIItNxDdu1vMBwgy6EeHypzogb7nmYG0bJsM6TeWfuKOrTR38+23m4+/cuYynswmE/XwRu58lf33619fN3X/xw716apWK7panqhB4+lbCdnSdbm59+//XW9vb23bvfFIvF1dXVTy4GV28ID3+///jB/RfPnq6trXEcNz09zV2QPO/5JAtJGiBSl1RFM1zHsS8Gl1KqOoHmBpoT2DFivf/RVf8AfagZtmKKZdwAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"proxy comments\"\n        title=\"proxy comments\"\n        src=\"/static/ed619c2e4b3009f87075d49c0b1f80c6/9a366/comments-b4.png\"\n        srcset=\"/static/ed619c2e4b3009f87075d49c0b1f80c6/9a366/comments-b4.png 212w\"\n        sizes=\"(max-width: 212px) 100vw, 212px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Now with the changes above...</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 568px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c8349ff25e1713d7908188433a5e7298/d63a8/test.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 10.7981220657277%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAIAAADXZGvcAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAWElEQVQI11XECQqAIBAAQP//yi61Td31zNKyIAgKhmEgRi0HmDrgfXa6ZXeu9qtGSgheiYAzmoXM4lDhM0serZkVCCl5svraXMs/RyQL4x5MTVRee6QS6QbEz3DrbwT1XQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"comments work\"\n        title=\"comments work\"\n        src=\"/static/c8349ff25e1713d7908188433a5e7298/d63a8/test.png\"\n        srcset=\"/static/c8349ff25e1713d7908188433a5e7298/53f68/test.png 213w,\n/static/c8349ff25e1713d7908188433a5e7298/df70d/test.png 425w,\n/static/c8349ff25e1713d7908188433a5e7298/d63a8/test.png 568w\"\n        sizes=\"(max-width: 568px) 100vw, 568px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>The forwarded IP addresses is no longer my proxy server :smile:</p>\n<p>Thanks to <a href=\"http://serverfault.com/questions/314574/nginx-real-ip-header-and-x-forwarded-for-seems-wrong\">Nick M from Server Fault</a>. I literally searched this for a whole hour and I'm just expanding on what he's provided already.</p>","timeToRead":3,"excerpt":"I love nginx. I love how its lightweight, does what it does well and is extremely fast. Nginx has the ability to perform server blocks…","fileAbsolutePath":"/home/runner/work/calvin.me/calvin.me/master/posts/2014/2014-12-27-forward-ip-addresses-when-using-nginx-proxy/index.md","frontmatter":{"title":"Forward IP Addresses with NGINX Proxy","categories":["Networking","Web"],"tags":["ip address","nginx","proxy"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#e8e8e8","images":{"fallback":{"src":"/static/7ebaa9c385d96f27cc84cbc50b1d8a1f/ccc8a/thumbnail.png","srcSet":"/static/7ebaa9c385d96f27cc84cbc50b1d8a1f/ccc8a/thumbnail.png 150w,\n/static/7ebaa9c385d96f27cc84cbc50b1d8a1f/67d4a/thumbnail.png 300w","sizes":"150px"},"sources":[{"srcSet":"/static/7ebaa9c385d96f27cc84cbc50b1d8a1f/3554d/thumbnail.webp 150w,\n/static/7ebaa9c385d96f27cc84cbc50b1d8a1f/c437f/thumbnail.webp 300w","type":"image/webp","sizes":"150px"}]},"width":150,"height":150}}}}}},"pageContext":{"filter":"/^.*\\/\\d{4}-\\d{2}-\\d{2}-forward-ip-addresses-when-using-nginx-proxy\\/.*$/"}},"staticQueryHashes":[]}