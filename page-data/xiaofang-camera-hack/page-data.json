{
    "componentChunkName": "component---src-templates-post-js",
    "path": "/xiaofang-camera-hack",
    "result": {"data":{"markdownRemark":{"html":"<p>Hacking a $25 indoor camera to do more than it's worth.</p>\n<!-- more -->\n<p>The Xiaomi Xiaofang IP camera is a indoor WiFi camera capable of 1080P resolution and decent night-vision. I purchased it to monitor my room and was happily surprised to find the base is magnetic!</p>\n<p>For the lowest price (shipped from China), check out the <a href=\"https://www.ozbargain.com.au/product/xiaomi-xiaofang\">OzBargain</a> page for the product.</p>\n<h2 id=\"out-of-the-box-limitations\" style=\"position:relative;\"><a href=\"#out-of-the-box-limitations\" aria-label=\"out of the box limitations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Out-of-the-box Limitations</h2>\n<p>Xiaomi has imposed a few limitations on this camera out of the box:</p>\n<ol>\n<li>Camera footage only viewable through the MiHome app.</li>\n<li>If the MiHome app is newer than version 4.0.11, the camera won't be accessible outside of China</li>\n<li>Maximum SD card size is 32GB</li>\n</ol>\n<h2 id=\"fixing-the-limitations\" style=\"position:relative;\"><a href=\"#fixing-the-limitations\" aria-label=\"fixing the limitations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Fixing the Limitations</h2>\n<p><a href=\"https://github.com/samtap\">@samtap</a> on GitHub has released a collection of modifications for the camera: <a href=\"https://github.com/samtap/fang-hacks\">https://github.com/samtap/fang-hacks</a>.</p>\n<p>There are a million guides on the Internet on how to get these installed so I won't cover it here.</p>\n<p>The main modification we'll be using for the camera is the built in RTSP (Real Time Streaming Protocol) server which will allow us to access the video stream from any compatible application. RTSP will be important for connecting it to my <a href=\"/home-security-cameras\">Milestone XProtect Video Management Server</a>.</p>\n<p>For my RTSP configuration, I went with 1024 x 576 at 15 fps. While 1080P 60FPS is entertaining, I didn't find it stable enough for my uses. This is configured within <code class=\"language-text\">/media/mmcblk0p2/data/etc/scripts/20-rtsp-server</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">snx_rtsp_server -W 1024 -H 576 -Q 10 -F 15 -b 1024 -a</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<h2 id=\"connecting-to-milestone-xprotect\" style=\"position:relative;\"><a href=\"#connecting-to-milestone-xprotect\" aria-label=\"connecting to milestone xprotect permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Connecting to Milestone XProtect</h2>\n<p>Once the RTSP stream is up and running at <code class=\"language-text\">rtsp://ip-address:554/unicast</code>, you can to connecting to it with VLC (File > Media > Open Network Stream). Connecting it to Milestone however using the Universal Driver does not work strangely. Others have run into this issue as well on the <a href=\"https://force.milestonesys.com/support/MccSupportCommunity?id=9060O000000Xb0UQAS\">Milestone Support Community</a>. Using Wireshark, I suspect the issue is the Universal Driver attempting to access <code class=\"language-text\">/unicast/</code> and <code class=\"language-text\">/unicast/track1</code> when <code class=\"language-text\">/unicast</code> without the trailing slash is the correct path.</p>\n<p>The alternative is to open the stream in VLC and pass it onto Milestone.</p>\n<p><img src=\"/da9c0b1d7aa3caf4651243a62e2d84ed/camera-stream.png\" alt=\"Add the camera\"></p>\n<h3 id=\"1-vlc-passthrough\" style=\"position:relative;\"><a href=\"#1-vlc-passthrough\" aria-label=\"1 vlc passthrough permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. VLC Passthrough</h3>\n<p>Save the following as a <code class=\"language-text\">.bat</code> file:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell-session\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell-session line-numbers\"><code class=\"language-shell-session\"><span class=\"token output\">C:\\..\\..\\vlc.exe rtsp://ip-address/unicast :sout=#rtp{sdp=rtsp://:8554/} :sout-keep</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>Then run the <code class=\"language-text\">.bat</code> file to start streaming from VLC without any video output to save CPU resources. The stream will be available at <code class=\"language-text\">rtsp://localhost:8554</code>.</p>\n<h3 id=\"2-add-vlc-passthrough-to-milestone\" style=\"position:relative;\"><a href=\"#2-add-vlc-passthrough-to-milestone\" aria-label=\"2 add vlc passthrough to milestone permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Add VLC passthrough to Milestone</h3>\n<p>In Milestone, add the VLC stream with the same configuration as below:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yaml line-numbers\"><code class=\"language-yaml\"><span class=\"token key atrule\">IP</span><span class=\"token punctuation\">:</span> localhost\n<span class=\"token key atrule\">Port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8554</span>\n<span class=\"token key atrule\">Username</span><span class=\"token punctuation\">:</span> &lt;default<span class=\"token punctuation\">></span>\n<span class=\"token key atrule\">Password</span><span class=\"token punctuation\">:</span>\n<span class=\"token key atrule\">Driver</span><span class=\"token punctuation\">:</span> Universal 1 channel driver</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><img src=\"/1e3195c2aa8f937285210b26c9b8014b/add-camera.png\" alt=\"Add the camera\"></p>\n<h3 id=\"3-configure-camera-settings\" style=\"position:relative;\"><a href=\"#3-configure-camera-settings\" aria-label=\"3 configure camera settings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Configure camera settings</h3>\n<p>Configure the camera with the same configuration as below:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yaml line-numbers\"><code class=\"language-yaml\"><span class=\"token key atrule\">Video Settings</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">Codec</span><span class=\"token punctuation\">:</span> H264\n  <span class=\"token key atrule\">Streaming Mode</span><span class=\"token punctuation\">:</span> RTP (UDP)\n  <span class=\"token key atrule\">Delivery mode</span><span class=\"token punctuation\">:</span> Multipart stream\n  <span class=\"token key atrule\">Keep-alive type</span><span class=\"token punctuation\">:</span> Default\n  <span class=\"token key atrule\">Retrieval mode</span><span class=\"token punctuation\">:</span> Streaming\n  <span class=\"token key atrule\">Connecting URI</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">RTSP port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8554</span>\n  <span class=\"token key atrule\">Include options on PLAY</span><span class=\"token punctuation\">:</span> No\n\n<span class=\"token key atrule\">Audio Settings</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">Codec</span><span class=\"token punctuation\">:</span> PCM A<span class=\"token punctuation\">-</span>law\n  <span class=\"token key atrule\">Streaming Mode</span><span class=\"token punctuation\">:</span> RTP (UDP)\n  <span class=\"token key atrule\">Delivery mode</span><span class=\"token punctuation\">:</span> Multipart stream\n  <span class=\"token key atrule\">Keep-alive type</span><span class=\"token punctuation\">:</span> Default\n  <span class=\"token key atrule\">Connecting URI</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">RTSP port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8554</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><img src=\"/18f0faf8f67b3e3e1a59f64fbffaf82a/camera-settings.png\" alt=\"Camera Settings\"></p>\n<h3 id=\"optional-autostart-vlc\" style=\"position:relative;\"><a href=\"#optional-autostart-vlc\" aria-label=\"optional autostart vlc permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Optional: Autostart VLC</h3>\n<p>There are two options when it comes to autostarting VLC with Windows.</p>\n<h4 id=\"run-bat-file-on-startup\" style=\"position:relative;\"><a href=\"#run-bat-file-on-startup\" aria-label=\"run bat file on startup permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Run .bat file on startup</h4>\n<p>Use Windows Task Scheduler. <strong>Make sure you have the absolute path to vlc.exe in the <code class=\"language-text\">.bat</code> file.</strong></p>\n<p><img src=\"/a2e5c3de30e5a566fb42a6e5f085656b/task-scheduler.png\" alt=\"Add the camera\"></p>\n<h4 id=\"install-as-a-windows-service\" style=\"position:relative;\"><a href=\"#install-as-a-windows-service\" aria-label=\"install as a windows service permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Install as a Windows Service</h4>\n<p>In my experience, running VLC as a Windows Service was caused Connection Errors with Milestone but your mileage may vary.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell-session\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell-session line-numbers\"><code class=\"language-shell-session\"><span class=\"token output\">vlc.exe -I ntservice --ntservice-install --ntservice-extraintf=http --ntservice-name=VLC --ntservice-options=\"rtsp://ip-address/unicast :sout=#rtp{sdp=rtsp://:8554/} :sout-keep\"</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>Then start the service.</p>","timeToRead":3,"excerpt":"Hacking a $25 indoor camera to do more than it's worth. The Xiaomi Xiaofang IP camera is a indoor WiFi camera capable of 1080P resolution…","fileAbsolutePath":"/home/runner/work/ariffrashid.com/ariffrashid.com/master/posts/2017/2017-08-01-xiaofang-camera-hack/index.md","frontmatter":{"title":"Hacking the Xiaomi Xiaofang Camera","categories":["Programming"],"tags":["xiaomi","camera"],"thumbnail":{"childImageSharp":null,"extension":"svg","publicURL":"/static/6a4404c8507e164b598ed54d046f567f/thumbnail.svg"}}}},"pageContext":{"filter":"/^.*\\/\\d{4}-\\d{2}-\\d{2}-xiaofang-camera-hack\\/.*$/"}},
    "staticQueryHashes": []}