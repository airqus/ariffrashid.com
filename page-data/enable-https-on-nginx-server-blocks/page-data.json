{"componentChunkName":"component---src-templates-post-js","path":"/enable-https-on-nginx-server-blocks","result":{"data":{"markdownRemark":{"html":"<p>Running HTTPS on NGINX is easy. Running a web server with HTTPS on <a href=\"https://www.nginx.com/resources/wiki/start/topics/examples/server_blocks/\">NGINX server blocks</a> can also be easy. The only real problem is getting your settings correct on both the web servers and proxy servers and where your SSL certificate and keys reside.</p>\n<!-- more -->\n<p><em>Example of server blocks on NGINX</em>:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 581px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6132ccf4bf67dffb888ae1f799924be8/3f4f8/drawing1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 83.09859154929579%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB60lEQVQ4y42S228SQRTG99/0PzA+mOiTD0ajD/rcRGNiDCYNLS2Nl2LAC1UuXWktbVqoFoFKC4Q1rG1xmcvuzJw5Y2CNFhHKeThP53fm+745lhktHHahdMR2Lj3+MrfWVqADIQG0GSvrv7DH1VPbubPaSJZPhQRCuVRwMXx+i0Y0U2sizIXuegI0GjQ4YcuY7OFY+yy4+aJxbbl6L9lkAv7YuQAOpe616OXo9q1E4Up0v3PmSylnhAe94vCrsZ0bz9evxz+7nhBS4OyeJegDh+0ce4dugJNjm572uRhmhxFNqdbMFffn80dcwDQY8d/tSpvVtB1ZWLkd33O9wPeDcV2IxsJRVGuUSksFn779TJV/vC67gVSg9agu/PtyoJD4ChGF0jA0ekJkICH8OUAjAE+pkKC1/g1SobkAK7O+GX+7sbjRCZMpV4/fZ7KPkqVD1x8cORPv8lsv0/ZioW2MAW0qTTeTtyPJ4oeDEyuWWJtbSj/JtUIlhVJ9fuXV3aWtyvcB3OdiOZV9GHvzIN0IB6qtbvRZ6v5CLrHbtYpNlql5DZeGdupd9rFB7XrPF2ogzxfbTZqrk6+dfnijTs/fPGLZmud6vkUIpZQKIYaqNCGMUsoZA60BdM+jhFBGGGOc+YMZzv1+n3DGAeAXA7jEEjFos88AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"nginx setup\"\n        title=\"nginx setup\"\n        src=\"/static/6132ccf4bf67dffb888ae1f799924be8/3f4f8/drawing1.png\"\n        srcset=\"/static/6132ccf4bf67dffb888ae1f799924be8/53f68/drawing1.png 213w,\n/static/6132ccf4bf67dffb888ae1f799924be8/df70d/drawing1.png 425w,\n/static/6132ccf4bf67dffb888ae1f799924be8/3f4f8/drawing1.png 581w\"\n        sizes=\"(max-width: 581px) 100vw, 581px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><strong>1.</strong> Grab a SSL Certificate. I got mine from <a href=\"https://www.startssl.com/%20\">StartSSL</a> for free. Supported in all the popular browsers.</p>\n<p>Digital Ocean has good write-up on <a href=\"https://www.digitalocean.com/community/tutorials/how-to-set-up-apache-with-a-free-signed-ssl-certificate-on-a-vps\">obtaining a certificate through StartSSL</a>. Come back here when it starts getting into 'Apache' as we're using NGINX.</p>\n<p>Place your SSL files on the Reverse Proxy server under '/etc/nginx/ssl/'</p>\n<p><strong>2.</strong> On the Reverse Proxy Server (<em>proxy</em> from now on), edit the configuration file for the remote host. I will be using <em>calvin.me</em> as the example.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell-session\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell-session line-numbers\"><code class=\"language-shell-session\"><span class=\"token output\">sudo nano /etc/nginx/sites-enabled/calvin.me</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>The original configuration file may look something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"nginx\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-nginx line-numbers\"><code class=\"language-nginx\"><span class=\"token directive\"><span class=\"token keyword\">server</span></span> <span class=\"token punctuation\">{</span>\n     <span class=\"token directive\"><span class=\"token keyword\">listen</span> <span class=\"token number\">80</span></span><span class=\"token punctuation\">;</span>\n     <span class=\"token directive\"><span class=\"token keyword\">server_name</span> calvin.me www.calvin.me</span><span class=\"token punctuation\">;</span>\n\n     <span class=\"token directive\"><span class=\"token keyword\">location</span> /</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token directive\"><span class=\"token keyword\">proxy_redirect</span> <span class=\"token boolean\">off</span></span><span class=\"token punctuation\">;</span>\n          <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> Host <span class=\"token variable\">$host</span></span><span class=\"token punctuation\">;</span>\n          <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> X-Real-IP <span class=\"token variable\">$remote_addr</span></span><span class=\"token punctuation\">;</span>\n          <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span></span><span class=\"token punctuation\">;</span>\n          <span class=\"token directive\"><span class=\"token keyword\">proxy_pass</span> http://your_remote_host_ip_or_fqdn_here</span><span class=\"token punctuation\">;</span>\n     <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Edit it so it looks like the one below. The new stuff is highlighted in red.</p>\n<div class=\"gatsby-highlight\" data-language=\"nginx\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-nginx line-numbers\"><code class=\"language-nginx\"><span class=\"token comment\"># redirect calvin.me to https</span>\n<span class=\"token directive\"><span class=\"token keyword\">server</span></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token directive\"><span class=\"token keyword\">listen</span>      <span class=\"token number\">80</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">server_name</span> calvin.me</span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">return</span> <span class=\"token number\">301</span> https://calvin.me</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># redirect www prefix to https</span>\n<span class=\"token directive\"><span class=\"token keyword\">server</span></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token directive\"><span class=\"token keyword\">listen</span>      <span class=\"token number\">80</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">server_name</span> www.calvin.me</span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">return</span> <span class=\"token number\">301</span> https://www.calvin.me</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># listen on https port (443)</span>\n<span class=\"token directive\"><span class=\"token keyword\">server</span></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token directive\"><span class=\"token keyword\">listen</span> <span class=\"token number\">443</span> ssl</span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">ssl_certificate</span> /etc/nginx/ssl/calvin.me.crt</span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">ssl_certificate_key</span> /etc/nginx/ssl/calvin.me.key</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token directive\"><span class=\"token keyword\">root</span> /var/www/calvin.me/html</span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">index</span> index.html index.htm</span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">server_name</span> calvin.me www.calvin.me</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token directive\"><span class=\"token keyword\">location</span> /</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token directive\"><span class=\"token keyword\">proxy_redirect</span>    http:// https://</span><span class=\"token punctuation\">;</span>\n            <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span>  Host <span class=\"token variable\">$host</span></span><span class=\"token punctuation\">;</span>\n            <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span>  X-Real-IP <span class=\"token variable\">$remote_addr</span></span><span class=\"token punctuation\">;</span>\n            <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span>  X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span></span><span class=\"token punctuation\">;</span>\n            <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span>  X-Forwarded-Proto https</span><span class=\"token punctuation\">;</span>\n            <span class=\"token directive\"><span class=\"token keyword\">proxy_pass</span>        http://wp.calvin.me</span><span class=\"token punctuation\">;</span>&lt;br>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><strong>3.</strong> Save and restart the NGINX server when done.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell-session\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell-session line-numbers\"><code class=\"language-shell-session\"><span class=\"token output\">sudo service nginx restart</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p><strong>Optional.</strong> If you are running WordPress you will have to add two lines into the <em>wp-config.php</em> file (on the <em>WordPress host</em>, not the <em>proxy</em>)</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-php line-numbers\"><code class=\"language-php\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_SERVER</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'HTTP_X_FORWARDED_PROTO'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token variable\">$_SERVER</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'HTTP_X_FORWARDED_PROTO'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token string single-quoted-string\">'https'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token variable\">$_SERVER</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'HTTPS'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'on'</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>Remember to change your WordPress Address and Site Address URL to 'https' instead of 'http' under Settings > General</p>\n<p><strong>4.</strong> Head over to the HTTPS version of your site and test it out (remember to port forward 443 if you have to).</p>","timeToRead":2,"excerpt":"Running HTTPS on NGINX is easy. Running a web server with HTTPS on NGINX server blocks can also be easy. The only real problem is getting…","fileAbsolutePath":"/home/runner/work/calvin.me/calvin.me/master/posts/2014-09-07-enable-https-on-nginx-server-blocks/index.md","frontmatter":{"title":"Enable HTTPS on NGINX Server Blocks","categories":["Networking","Web"],"tags":["nginx","https"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#e8e8e8","images":{"fallback":{"src":"/static/aa4e0211e3996cc1e0849cc8b2ec5745/ccc8a/thumbnail.png","srcSet":"/static/aa4e0211e3996cc1e0849cc8b2ec5745/ccc8a/thumbnail.png 150w,\n/static/aa4e0211e3996cc1e0849cc8b2ec5745/67d4a/thumbnail.png 300w","sizes":"150px"},"sources":[{"srcSet":"/static/aa4e0211e3996cc1e0849cc8b2ec5745/3554d/thumbnail.webp 150w,\n/static/aa4e0211e3996cc1e0849cc8b2ec5745/c437f/thumbnail.webp 300w","type":"image/webp","sizes":"150px"}]},"width":150,"height":150}}}}}},"pageContext":{"filter":"/^.*\\/\\d{4}-\\d{2}-\\d{2}-enable-https-on-nginx-server-blocks\\/.*$/"}},"staticQueryHashes":[]}